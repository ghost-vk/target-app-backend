<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: lid.controller.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: lid.controller.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>const db = require('./../db')
const { lidSchema } = require('./../utils/validation-schemes')
const {
  isValidPhoneNumber,
  isSupportedCountry,
  parsePhoneNumber,
} = require('libphonenumber-js')

/**
 * Controller of '/api/lid'
 * @class
 */
class LidController {
  /**
   * Method creates lid and save to database
   * @param {string|undefined}  name - The name of lid. Should be min length 2.
   * @param {string} phone - The valid phone number of lid.
   * @param {string} countryCode - Two-letter ISO country code (like 'RU').
   * @param {string|undefined} email - The email address of lid.
   * @param {string|undefined} source - The source where are from lid. Min length 5.
   * @returns {object} Returns empty body with status 204 if success and object with errors if not: { status: 'error', errors: { name: '...', phone: '...', countryCode: '', email: '...', source: '...'  } }
   */
  async createLid(req, res) {
    const data = {
      name: req.body.name,
      phone: req.body.phone,
      countryCode: req.body.countryCode,
      email: req.body.email,
      source: req.body.source,
    }
    const errors = {
      name: '',
      phone: '',
      countryCode: '',
      email: '',
      source: '',
    }
    try {
      await lidSchema.schema.validate(data, { abortEarly: false })
      if (!isSupportedCountry(data.countryCode)) {
        errors.phone = 'Не поддерживаемый код страны'
        res.status(405).json({ status: 'error', errors })
      }
      if (!isValidPhoneNumber(data.phone, data.countryCode)) {
        errors.phone = 'Не действительный номер телефона'
        res.status(405).json({ status: 'error', errors })
      }
      const parsedPhone = parsePhoneNumber(
        data.phone,
        data.countryCode
      ).formatInternational()
      const newLid = await db.query(
        `INSERT INTO lids (name, phone, email, source, country_code) VALUES ($1, $2, $3, $4, $5) RETURNING *`,
        [data.name, parsedPhone, data.email, data.source, data.countryCode]
      )
      if (newLid.rows[0]?.phone?.length > 0) {
        res.status(204).json({})
      } else {
        res.status(500).json({ status: 'error' })
      }
    } catch (err) {
      err?.inner?.forEach((error) => {
        errors[error.path] = errors[error.path] || error.message
      })
      res.status(500).json({ status: 'error', errors })
    }
  }
}

module.exports = new LidController()
</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Classes</h3><ul><li><a href="LidController.html">LidController</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc/jsdoc">JSDoc 3.6.7</a> on Wed Aug 25 2021 15:44:52 GMT+0300 (Moscow Standard Time)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
